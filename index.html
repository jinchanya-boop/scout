<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #ddd6fe 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .activity-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }
        .signature-pad {
            border: 2px dashed #c4b5fd;
            background: #faf5ff;
        }
        .rubric-item {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <header class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üèïÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏ç‡πà - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤</h1>
                        <p class="text-sm text-purple-600"> ‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ ‡∏°.1-‡∏°.3</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <select id="gradeSelect" class="px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="m1">‡∏°.1 - ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß</option>
                        <option value="m2">‡∏°.2 - ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ</option>
                        <option value="m3">‡∏°.3 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <button onclick="openStudentManagement()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-purple-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üë•</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    </div>
                </div>
            </button>
            <button onclick="openAttendanceCheck()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-purple-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">‚úÖ</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                        <p class="text-sm text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                    </div>
                </div>
            </button>
             <button onclick="openDashboard()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-blue-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìà</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h3>
                        <p class="text-sm text-gray-600">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</p>
                    </div>
                </div>
            </button>
            <button onclick="showActivityReport()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-green-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìä</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                        <p class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                    </div>
                </div>
            </button>
            <button onclick="showAttendanceReport()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-yellow-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìã</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                        <p class="text-sm text-gray-600">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                    </div>
                </div>
            </button>
        </div>

        <div class="bg-white/90 backdrop-blur-md rounded-2xl card-shadow p-6 mb-8">
            <div class="flex items-center mb-6">
                <span class="text-2xl mr-3">üìÖ</span>
                <h2 class="text-2xl font-bold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™</h2>
            </div>
            
            <div id="scheduleTable" class="overflow-x-auto">
                </div>
        </div>
    </main>

    <div id="studentManagementModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        </div>
    <div id="attendanceModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        </div>
    <div id="activityModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        </div>

    <div id="dashboardModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-purple-100 sticky top-0 bg-white/80 backdrop-blur-md">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üìà</span>
                        <h3 class="text-xl font-bold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
                    </div>
                    <button onclick="closeDashboard()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="mt-4">
                    <label for="dashboardGradeFilter" class="text-sm font-medium text-gray-700">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label>
                    <select id="dashboardGradeFilter" onchange="renderDashboardCharts()" class="mt-1 w-full md:w-auto px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡∏°.1">‡∏°.1</option>
                        <option value="‡∏°.2">‡∏°.2</option>
                        <option value="‡∏°.3">‡∏°.3</option>
                    </select>
                </div>
            </div>
            
            <div class="p-6 space-y-8">
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h4>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h4>
                    <div class="p-4 bg-gray-50 rounded-lg">
                         <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // #############################################################################
        // #                            CONFIGURATION                                  #
        // #############################################################################
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_V2hmixpjY3JEv_u1yLThuAWyj5jiUL5mg8bT0Nafc7r5nT2onTOLB_zjIHzOumOV/exec'; // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        
        // #############################################################################
        // #                            GLOBAL VARIABLES                               #
        // #############################################################################
        
        let studentData = {};
        let editingStudent = null;
        let canvas, ctx, isDrawing = false;
        let activityRecords = JSON.parse(localStorage.getItem('scoutActivityRecords') || '[]');
        let attendanceRecords = JSON.parse(localStorage.getItem('scoutAttendanceRecords') || '[]');
        
        // üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°] Global variables ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞ instance ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        let attendanceSummaryData = null;
        let activitySummaryData = null;
        let attendanceChartInstance = null;
        let scoreChartInstance = null;

        const scheduleData = {
            m1: {
                title: "‡∏°.1 - ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß",
                focus: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‚Äì ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‚Äì ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏ò‡∏á‡∏ä‡∏≤‡∏ï‡∏¥", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (2‚Äì3 ‡∏Å‡∏°.)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ö‡∏≤‡∏î‡πÅ‡∏ú‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏û‡∏¥‡∏£‡∏≠‡∏î, ‡∏ï‡∏∞‡∏Å‡∏£‡∏∏‡∏î‡πÄ‡∏ö‡πá‡∏î, ‡∏Ç‡∏±‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥)", day2: "‡∏ù‡∏∂‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®", day3: "‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡πÑ‡∏ü‡∏á‡πà‡∏≤‡∏¢ ‡πÜ" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡πÄ‡∏Å‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Teamwork", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ú‡∏π‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏ú‡∏π‡πâ‡∏ï‡∏≤‡∏°", day2: "‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠", day3: "‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î (Reflection)" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            },
            m2: {
                title: "‡∏°.2 - ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
                focus: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‚Äì ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå ‚Äì ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏à‡∏£‡∏¥‡∏á ‚Äì ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏°‡∏π‡πà, ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (4‚Äì5 ‡∏Å‡∏°.)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î, ‡∏´‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö)" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå (‡∏ö‡πà‡∏ß‡∏á‡∏™‡∏≤‡∏¢‡∏ò‡∏ô‡∏π, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤)", day2: "‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ / ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", day3: "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏ú‡∏π‡πâ‡∏ï‡∏≤‡∏°", day2: "‡∏ê‡∏≤‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏à/Team Building", day3: "‡πÄ‡∏Å‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡∏ä‡∏∏‡∏°‡∏ä‡∏ô/‡∏ß‡∏±‡∏î)", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏® + ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°", day2: "‡πÄ‡∏û‡∏•‡∏á‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            },
            m3: {
                title: "‡∏°.3 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î",
                focus: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ ‚Äì ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‚Äì ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î ‚Äì ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤ (‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (6‚Äì8 ‡∏Å‡∏°. + ‡∏ê‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏î‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å, ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢)" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡∏π‡∏Å‡∏£‡∏≠‡∏Å, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏≠)", day2: "‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô / ‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô", day3: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î (‡∏´‡∏≤‡∏ô‡πâ‡∏≥, ‡∏´‡∏≤‡∏ó‡∏¥‡∏®‡∏à‡∏≤‡∏Å‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß)" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (‡∏ù‡∏∂‡∏Å‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å)", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ê‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢", day3: "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.3 ‡∏à‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á ‡∏°.1‚Äì‡∏°.2" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏•‡πá‡∏Å ‡πÜ)", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏£‡∏ß‡∏° (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏® + ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• + ‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à", day2: "‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå (Mini Camp Fire)", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            }
        };

        const rubricCriteria = {
            default: [
                { criteria: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", maxScore: 25 }, { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏ó‡∏µ‡∏°", maxScore: 25 },
                { criteria: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö", maxScore: 25 }, { criteria: "‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", maxScore: 25 }
            ],
            skill: [
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ", maxScore: 30 }, { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", maxScore: 25 },
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", maxScore: 25 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á", maxScore: 20 }
            ],
            leadership: [
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥", maxScore: 30 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", maxScore: 25 },
                { criteria: "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à", maxScore: 25 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", maxScore: 20 }
            ]
        };

        // #############################################################################
        // #                           INITIALIZATION                                  #
        // #############################################################################
        
            document.addEventListener('DOMContentLoaded', function () {
            fetchStudents();
            setupSignatureCanvas();
            document.getElementById('gradeSelect').addEventListener('change', loadSchedule);
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addStudentForm').addEventListener('submit', (e) => { e.preventDefault(); saveStudent(); });
            document.getElementById('activityForm').addEventListener('submit', (e) => { e.preventDefault(); saveActivityRecord(); });
        });

        // #############################################################################
        // #                            DATA HANDLING                                  #
        // #############################################################################

        async function fetchStudents() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getStudents');
                if (!response.ok) throw new Error('Network response was not ok');
                studentData = await response.json();
                console.log('Student data loaded successfully:', studentData);
            } catch (error) {
                console.error('Failed to fetch students:', error);
                Swal.fire({
                    icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script',
                    confirmButtonColor: '#8b5cf6'
                });
            } finally {
                // üü¢ [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                loadSchedule(); 
            }
        }
        

        // #############################################################################
        // #                      üü¢ [‡πÄ‡∏û‡∏¥‡πà‡∏°] DASHBOARD FUNCTIONS                        #
        // #############################################################################

        function openDashboard() {
            document.getElementById('dashboardModal').classList.remove('hidden');
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            if (!attendanceSummaryData || !activitySummaryData) {
                loadDashboardData();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ render ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏•‡∏¢
                renderDashboardCharts();
            }
        }

        function closeDashboard() {
            document.getElementById('dashboardModal').classList.add('hidden');
        }

        async function loadDashboardData() {
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const [attendanceRes, activityRes] = await Promise.all([
                    fetch(SCRIPT_URL + '?action=getAttendanceSummary'),
                    fetch(SCRIPT_URL + '?action=getActivitySummary')
                ]);

                if (!attendanceRes.ok || !activityRes.ok) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ');
                }

                attendanceSummaryData = await attendanceRes.json();
                activitySummaryData = await activityRes.json();
                
                renderDashboardCharts(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                Swal.close();

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ'
                });
            }
        }

        function renderDashboardCharts() {
    if (!attendanceSummaryData || !activitySummaryData) {
        console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü");
        return;
    }

    const gradeFilterValue = document.getElementById('dashboardGradeFilter').value;
    const gradeMapping = {
        "‡∏°.1": "m1",
        "‡∏°.2": "m2",
        "‡∏°.3": "m3",
        "all": "all"
    };
    const selectedGrade = gradeMapping[gradeFilterValue];

    // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ---
    const attendanceLabels = [];
    const attendanceData = {
        present: [],
        leave: [],
        absent: [],
        skipped: []
    };

    for (const gradeKey in attendanceSummaryData) {
        if (selectedGrade !== 'all' && gradeKey !== selectedGrade) continue;

        for (const group in attendanceSummaryData[gradeKey]) {
            for (const troop in attendanceSummaryData[gradeKey][group]) {
                const troopData = attendanceSummaryData[gradeKey][group][troop];
                const displayGrade = gradeKey.replace('m', '‡∏°.'); 
                const label = `${displayGrade}/${group}/${troop}`;

                attendanceLabels.push(label);
                attendanceData.present.push(troopData['‡∏°‡∏≤'] || 0);
                attendanceData.leave.push(troopData['‡∏•‡∏≤'] || 0);
                attendanceData.absent.push(troopData['‡∏Ç‡∏≤‡∏î'] || 0);
                attendanceData.skipped.push(troopData['‡∏´‡∏ô‡∏µ'] || 0);
            }
        }
    }
    
    // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ---
    const scoreLabels = [];
    const scoreData = [];

    for (const gradeKey in activitySummaryData) {
        if (selectedGrade !== 'all' && gradeKey !== selectedGrade) continue;
        
        for (const group in activitySummaryData[gradeKey].groups) {
             for (const troop in activitySummaryData[gradeKey].groups[group].troops) {
                const troopData = activitySummaryData[gradeKey].groups[group].troops[troop];
                const displayGrade = gradeKey.replace('m', '‡∏°.');
                const label = `${displayGrade}/${group}/${troop}`;
                const avgScore = troopData.count > 0 ? (troopData.totalScore / troopData.count).toFixed(2) : 0;
                scoreLabels.push(label);
                scoreData.push(avgScore);
            }
        }
    }

    // --- 3. ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ---
    if (attendanceChartInstance) {
        attendanceChartInstance.destroy();
    }
    if (scoreChartInstance) {
        scoreChartInstance.destroy();
    }

    // --- 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ---
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    attendanceChartInstance = new Chart(attendanceCtx, {
        type: 'bar',
        data: {
            labels: attendanceLabels,
            datasets: [
                { label: '‡∏°‡∏≤', data: attendanceData.present, backgroundColor: '#10B981' },
                { label: '‡∏•‡∏≤', data: attendanceData.leave, backgroundColor: '#F59E0B' },
                { label: '‡∏Ç‡∏≤‡∏î', data: attendanceData.absent, backgroundColor: '#EF4444' },
                { label: '‡∏´‡∏ô‡∏µ', data: attendanceData.skipped, backgroundColor: '#F97316' }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            },
            plugins: {
                title: { display: true, text: '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' },
                tooltip: { mode: 'index' }
            }
        }
    });

    // --- 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ---
    const scoreCtx = document.getElementById('scoreChart').getContext('2d');
    scoreChartInstance = new Chart(scoreCtx, {
        type: 'bar',
        data: {
            labels: scoreLabels,
            datasets: [{
                label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢',
                data: scoreData,
                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 100 }
            },
             plugins: {
                title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà' }
            }
        }
    });
}

        
        // #############################################################################
        // #                             UI & DISPLAY                                  #
        // #############################################################################

        function loadSchedule() {
            const selectedGrade = document.getElementById('gradeSelect').value;
            const data = scheduleData[selectedGrade];
            const tableContainer = document.getElementById('scheduleTable');
            
            let html = `
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-purple-800">${data.title}</h3>
                    <p class="text-sm text-gray-600 mt-1"><strong>‡∏à‡∏∏‡∏î‡πÄ‡∏ô‡πâ‡∏ô:</strong> ${data.focus}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            data.schedule.forEach((row) => {
                const isBreak = row.day1.includes('‡∏û‡∏±‡∏Å');
                const btn = (day, activity) => !isBreak ? `<button onclick="openActivityModal('${row.time}', '${activity.replace(/'/g, "\\'")}', ${day})" class="ml-2 px-3 py-1 bg-purple-500 text-white text-xs rounded-full hover:bg-purple-600 transition-colors">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>` : '';
                html += `
                    <tr class="${isBreak ? 'bg-purple-50' : 'bg-white hover:bg-purple-50'} transition-colors">
                        <td class="border border-purple-200 px-4 py-3 font-medium text-purple-700">${row.time}</td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day1}</span>${btn(1, row.day1)}</div></td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day2}</span>${btn(2, row.day2)}</div></td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day3}</span>${btn(3, row.day3)}</div></td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>`;
            tableContainer.innerHTML = html;
        }
        
        function loadManageStudentList() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    const container = document.getElementById('manageStudentList');
    
    // ‡πÉ‡∏ä‡πâ optional chaining (?.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏´‡∏≤‡∏Å object level ‡πÉ‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ
    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = `
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-gray-800 mb-3">${grade} / ${group} / ${troop} - ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${students.length} ‡∏Ñ‡∏ô)</h4>
            </div>
            <div class="space-y-3">`;
        
        if (students.length > 0) {
            students.forEach((student, index) => {
                html += `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-purple-600 font-medium">${index + 1}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.firstName} ${student.lastName}</div>
                                <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${student.id}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editStudent('${grade}', '${group}', '${troop}', ${index})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteStudent('${grade}', '${group}', '${troop}', ${index})" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg">üóëÔ∏è ‡∏•‡∏ö</button>
                        </div>
                    </div>`;
            });
        } else {
            html += `<p class="text-center text-gray-500">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }

        html += '</div>';
        container.innerHTML = html;
    } else {
        container.innerHTML = `<div class="text-center text-gray-500 py-8"><span class="text-4xl block mb-2">üë•</span><p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p></div>`;
    }
}

function showAddStudentForm() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    
    if (!grade || !group || !troop) {
        Swal.fire({
            icon: 'warning',
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',
            text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
            confirmButtonColor: '#8b5cf6'
        });
        return;
    }
    
    editingStudent = null;
    document.getElementById('formTitle').textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (${grade} / ${group} / ${troop})`;
    document.getElementById('addStudentForm').reset();
    document.getElementById('studentForm').classList.remove('hidden');
}

async function saveStudent() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    const firstName = document.getElementById('studentFirstName').value.trim();
    const lastName = document.getElementById('studentLastName').value.trim();
    const studentId = document.getElementById('studentId').value.trim();

    const studentObj = { id: studentId, firstName, lastName, grade, group, troop };
    const payload = {
        type: 'manageStudent',
        action: editingStudent ? 'edit' : 'add',
        student: studentObj,
        ...(editingStudent && { originalId: editingStudent.originalId })
    };

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', willOpen: () => Swal.showLoading() });

    try {
        await postData(payload);

        // Update local data
        if (editingStudent) {
            const oldList = studentData[editingStudent.grade]?.[editingStudent.group]?.[editingStudent.troop] || [];
            const studentIndex = oldList.findIndex(s => s.id === editingStudent.originalId);
            if (studentIndex > -1) oldList.splice(studentIndex, 1);
        }
        if (!studentData[grade]) studentData[grade] = {};
        if (!studentData[grade][group]) studentData[grade][group] = {};
        if (!studentData[grade][group][troop]) studentData[grade][group][troop] = [];
        studentData[grade][group][troop].push({ id: studentId, firstName, lastName });

        hideStudentForm();
        loadManageStudentList();
        Swal.fire({ icon: 'success', title: editingStudent ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    } catch (error) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message });
    }
}

function editStudent(grade, group, troop, index) {
    const student = studentData[grade]?.[group]?.[troop]?.[index];
    if (!student) return;
    editingStudent = { grade, group, troop, index, originalId: student.id };
    
    document.getElementById('formTitle').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${grade}/${group}/${troop})`;
    document.getElementById('studentFirstName').value = student.firstName;
    document.getElementById('studentLastName').value = student.lastName;
    document.getElementById('studentId').value = student.id;
    document.getElementById('studentForm').classList.remove('hidden');
}

function deleteStudent(grade, group, troop, index) {
    const student = studentData[grade]?.[group]?.[troop]?.[index];
    if (!student) return;

    Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${student.firstName} ${student.lastName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', willOpen: () => Swal.showLoading() });
            try {
                await postData({ type: 'manageStudent', action: 'delete', student: { id: student.id } });
                studentData[grade][group][troop].splice(index, 1);
                loadManageStudentList();
                Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message });
            }
        }
    });
}
        
        function loadAttendanceStudentList() {
    const grade = document.getElementById('attendanceGrade').value; //  <-- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
    const group = document.getElementById('attendanceGroup').value;
    const troop = document.getElementById('attendanceTroop').value;
    const container = document.getElementById('attendanceStudentList');

    // ‡πÉ‡∏ä‡πâ optional chaining (?.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô > ‡∏Å‡∏≠‡∏á > ‡∏´‡∏°‡∏π‡πà
    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = `
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-gray-800">${grade} / ${group} / ${troop} - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (${students.length} ‡∏Ñ‡∏ô)</h4>
            </div>
            <div class="space-y-3">`;
        
        if (students.length > 0) {
            students.forEach(student => {
                html += `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-purple-600 font-medium">${student.firstName.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.firstName} ${student.lastName}</div>
                                <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${student.id}</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-x-3 gap-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏°‡∏≤" class="text-green-600" checked><span class="text-sm font-medium">‚úÖ ‡∏°‡∏≤</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏•‡∏≤" class="text-yellow-600"><span class="text-sm font-medium">üìã ‡∏•‡∏≤</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏Ç‡∏≤‡∏î" class="text-red-600"><span class="text-sm font-medium">‚ùå ‡∏Ç‡∏≤‡∏î</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏´‡∏ô‡∏µ" class="text-orange-600"><span class="text-sm font-medium">üèÉ ‡∏´‡∏ô‡∏µ</span></label>
                        </div>
                    </div>`;
            });
        } else {
             html += `<p class="text-center text-gray-500 py-4">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    } else {
        container.innerHTML = `<div class="text-center text-gray-500 py-8"><span class="text-4xl block mb-2">‚úÖ</span><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p></div>`;
    }
}
        
        // #############################################################################
        // #                           UTILITY FUNCTIONS                               #
        // #############################################################################
        
        function updateTroopOptions(groupElId, troopElId) {
            const groupSelect = document.getElementById(groupElId);
            const troopSelect = document.getElementById(troopElId);
            troopSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>';
            if (groupSelect.value) {
                for (let i = 1; i <= 4; i++) {
                    troopSelect.innerHTML += `<option value="‡∏´‡∏°‡∏π‡πà${i}">‡∏´‡∏°‡∏π‡πà ${i}</option>`;
                }
            }
        }
        function updateManageTroopOptions() { updateTroopOptions('manageGroup', 'manageTroop'); }
        function updateAttendanceTroopOptions() { updateTroopOptions('attendanceGroup', 'attendanceTroop'); }
        function updateActivityTroopOptions() { 
            updateTroopOptions('selectedGroup', 'selectedTroop');
            document.getElementById('selectedTroop').disabled = !document.getElementById('selectedGroup').value;
        }

        function loadStudentList() {
    const grade = document.getElementById('activityGrade').value;
    const group = document.getElementById('selectedGroup').value;
    const troop = document.getElementById('selectedTroop').value;
    const container = document.getElementById('studentCheckList');
    const wrapper = document.getElementById('studentAttendanceList');
    const summaryWrapper = document.getElementById('attendanceSummary'); // <-- ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ

    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = '';
        if (students.length > 0) {
            students.forEach(student => {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° onchange="updateAttendanceSummary()" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô input ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
                html += `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-3">
                            <span class="font-medium text-gray-800">${student.firstName} ${student.lastName}</span>
                            <span class="text-sm text-gray-500">(${student.id})</span>
                        </div>
                        <div class="flex space-x-2">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏°‡∏≤" class="text-green-600" checked>
                                <span class="text-sm">‡∏°‡∏≤</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏•‡∏≤" class="text-yellow-600">
                                <span class="text-sm">‡∏•‡∏≤</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏Ç‡∏≤‡∏î" class="text-red-600">
                                <span class="text-sm">‡∏Ç‡∏≤‡∏î</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏´‡∏ô‡∏µ" class="text-orange-600">
                                <span class="text-sm">‡∏´‡∏ô‡∏µ</span>
                            </label>
                        </div>
                    </div>
                `;
            });
        } else {
            html = `<p class="text-center text-gray-500 py-2">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }
        
        container.innerHTML = html;
        wrapper.classList.remove('hidden');
        summaryWrapper.classList.remove('hidden'); // <-- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        updateAttendanceSummary(); 

    } else {
        container.innerHTML = ''; 
        wrapper.classList.add('hidden');
        summaryWrapper.classList.add('hidden'); // <-- ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    }
}
        function updateAttendanceSummary() {
    const container = document.getElementById('studentCheckList');
    if (!container) return;

    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å radio button ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const presentCount = container.querySelectorAll('input[value="‡∏°‡∏≤"]:checked').length;
    const leaveCount = container.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length;
    const absentCount = container.querySelectorAll('input[value="‡∏Ç‡∏≤‡∏î"]:checked').length;
    const skippedCount = container.querySelectorAll('input[value="‡∏´‡∏ô‡∏µ"]:checked').length;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ
    document.getElementById('summaryPresent').innerText = presentCount;
    document.getElementById('summaryLeave').innerText = leaveCount;
    document.getElementById('summaryAbsent').innerText = absentCount;
    document.getElementById('summarySkipped').innerText = skippedCount;
}

        // --- MODAL & FORM VISIBILITY ---
        function openStudentManagement() { document.getElementById('studentManagementModal').classList.remove('hidden'); }
        function closeStudentManagement() { document.getElementById('studentManagementModal').classList.add('hidden'); hideStudentForm(); }
        function openAttendanceCheck() { document.getElementById('attendanceModal').classList.remove('hidden'); }
        function closeAttendanceCheck() { document.getElementById('attendanceModal').classList.add('hidden'); }
        function closeModal() { document.getElementById('activityModal').classList.add('hidden'); document.getElementById('activityForm').reset(); clearSignature(); }
        function hideStudentForm() { document.getElementById('studentForm').classList.add('hidden'); editingStudent = null; document.getElementById('addStudentForm').reset(); }
        function showAddStudentForm() {
            if (!document.getElementById('manageGroup').value || !document.getElementById('manageTroop').value) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô', confirmButtonColor: '#8b5cf6' });
                return;
            }
            editingStudent = null;
            document.getElementById('formTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('addStudentForm').reset();
            document.getElementById('studentForm').classList.remove('hidden');
        }

        // --- ACTIVITY MODAL & RUBRIC ---
        function openActivityModal(time, activity, day) {
            document.getElementById('activityTime').value = time;
            document.getElementById('activityName').value = activity;
            let criteriaKey = 'default';
            if (['‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô', '‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®', '‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'].some(s => activity.includes(s))) criteriaKey = 'skill';
            else if (['‡∏ú‡∏π‡πâ‡∏ô‡∏≥', '‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤'].some(s => activity.includes(s))) criteriaKey = 'leadership';
            loadRubricItems(rubricCriteria[criteriaKey]);
            document.getElementById('activityModal').classList.remove('hidden');
        }

        function loadRubricItems(criteria) {
            const container = document.getElementById('rubricItems');
            container.innerHTML = criteria.map((item, index) => `
                <div class="rubric-item rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-800">${item.criteria}</span>
                        <span class="text-sm text-purple-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°: ${item.maxScore}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="range" min="0" max="${item.maxScore}" value="0" class="flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer" id="rubric_${index}" oninput="updateRubricScore()">
                        <span id="score_${index}" class="font-bold text-purple-600 min-w-[60px]">0/${item.maxScore}</span>
                    </div>
                </div>`).join('');
            updateRubricScore(); // Set initial total score to 0
        }

        function updateRubricScore() {
            let total = 0;
            document.querySelectorAll('[id^="rubric_"]').forEach((item, index) => {
                const value = parseInt(item.value);
                const maxScore = parseInt(item.max);
                document.getElementById(`score_${index}`).textContent = `${value}/${maxScore}`;
                total += value;
            });
            document.getElementById('totalScore').value = total;
            const gradeSelect = document.getElementById('gradeLevel');
            if (total >= 90) gradeSelect.value = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
            else if (total >= 80) gradeSelect.value = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
            else if (total >= 70) gradeSelect.value = '‡∏î‡∏µ';
            else if (total >= 60) gradeSelect.value = '‡∏û‡∏≠‡πÉ‡∏ä‡πâ';
            else gradeSelect.value = '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
        }

        // --- SIGNATURE CANVAS ---
        function setupSignatureCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            clearSignature();
            ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDraw));
            ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, draw));
            ['mouseup', 'mouseout', 'touchend'].forEach(evt => canvas.addEventListener(evt, stopDraw));
        }
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches?.[0];
            return [ (e.clientX || touch.clientX) - rect.left, (e.clientY || touch.clientY) - rect.top ];
        }
        function startDraw(e) { e.preventDefault(); isDrawing = true; [ctx.lastX, ctx.lastY] = getCoords(e); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); drawLine(...getCoords(e)); }
        function stopDraw() { isDrawing = false; }
        function drawLine(x, y) {
            ctx.beginPath();
            ctx.moveTo(ctx.lastX, ctx.lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
            [ctx.lastX, ctx.lastY] = [x, y];
        }
        function clearSignature() { ctx.fillStyle = '#faf5ff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }

        // --- LOCAL STORAGE & REPORTS ---
        function saveDataLocally(data) {
            try {
                const records = data.type === 'attendance' ? attendanceRecords : activityRecords;
                const key = data.type === 'attendance' ? 'scoutAttendanceRecords' : 'scoutActivityRecords';
                records.push(data);
                localStorage.setItem(key, JSON.stringify(records));
            } catch (error) { console.error('Error saving locally:', error); }
        }

        function showSuccessMessage(data, isOffline = false) {
            const commonProps = { confirmButtonColor: '#8b5cf6', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' };
            const statusHtml = `<div class="mt-4 p-3 ${isOffline ? 'bg-yellow-100' : 'bg-green-100'} rounded-lg text-sm">${isOffline ? '‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' : '‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß'}</div>`;
            if (data.type === 'attendance') {
                closeAttendanceCheck();
                Swal.fire({
                    ...commonProps, icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
                    html: `<div class="text-left"><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.date}</p><p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${data.activity}</p><p><strong>‡∏Å‡∏≠‡∏á-‡∏´‡∏°‡∏π‡πà:</strong> ${data.group} ${data.troop}</p></div>` + statusHtml,
                });
            } else {
                closeModal();
                Swal.fire({
                    ...commonProps, icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
                    html: `<div class="text-left"><p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${data.activity}</p><p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> ${data.totalScore}/100</p><p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${data.gradeLevel}</p></div>` + statusHtml,
                });
            }
        }
        
        async function showActivityReport() {
    Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        const response = await fetch(SCRIPT_URL + '?action=getActivitySummary');
        const summary = await response.json();

        if (Object.keys(summary).length === 0) {
            return Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', confirmButtonColor: '#8b5cf6' });
        }

        let reportHtml = `<div class="max-h-[70vh] overflow-y-auto text-left space-y-2">`;
        
        // Loop ‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
        for (const gradeName in summary) {
            const gradeData = summary[gradeName];
            const gradeAvg = (gradeData.totalScore / gradeData.count).toFixed(2);

            reportHtml += `
                <details class="bg-gray-100 rounded-xl border border-gray-300 overflow-hidden">
                    <summary class="p-4 font-bold text-xl text-gray-800 cursor-pointer flex justify-between hover:bg-gray-200">
                        <span>${gradeName.toUpperCase()}</span>
                        <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°: ${gradeAvg}</span>
                    </summary>
                    <div class="px-4 py-2 border-t border-gray-300 space-y-3">`;

            // Loop ‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡∏Å‡∏≠‡∏á
            for (const groupName in gradeData.groups) {
                const groupData = gradeData.groups[groupName];
                const groupAvg = (groupData.totalScore / groupData.count).toFixed(2);
                
                reportHtml += `
                    <details class="bg-purple-50 rounded-lg border border-purple-200">
                        <summary class="p-3 font-semibold text-lg text-purple-800 cursor-pointer flex justify-between hover:bg-purple-100">
                            <span>${groupName}</span>
                            <span>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${groupAvg}</span>
                        </summary>
                        <div class="p-3 border-t border-purple-200 space-y-2">`;
                
                // Loop ‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏™‡∏∏‡∏î: ‡∏´‡∏°‡∏π‡πà
                for (const troopName in groupData.troops) {
                    const troopData = groupData.troops[troopName];
                    const troopAvg = (troopData.totalScore / troopData.count).toFixed(2);
                    
                    const activitiesHtml = troopData.activities.map(act => `
                        <div class="flex justify-between text-sm py-1 pl-4 text-gray-600">
                            <span>- ${act.name}</span>
                            <span>${act.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </div>
                    `).join('');

                    reportHtml += `
                        <details class="bg-white rounded-md border">
                            <summary class="p-2 font-medium cursor-pointer flex justify-between text-gray-800 text-base">
                                <span>${troopName}</span>
                                <span class="text-sm">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${troopAvg} (${troopData.count} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)</span>
                            </summary>
                            <div class="px-2 pb-1 border-t">${activitiesHtml}</div>
                        </details>`;
                }
                
                reportHtml += `</div></details>`;
            }
            
            reportHtml += `</div></details>`;
        }
        
        reportHtml += '</div>';
        
        Swal.fire({
            title: 'üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
            html: reportHtml,
            width: '800px',
            confirmButtonText: '‡∏õ‡∏¥‡∏î',
            confirmButtonColor: '#8b5cf6'
        });

    } catch (error) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' });
        console.error(error);
    }
}

async function showAttendanceReport() {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ...', didOpen: () => Swal.showLoading() });

        try {
            const response = await fetch(SCRIPT_URL + '?action=getAttendanceSummary');
            const summary = await response.json();

            if (Object.keys(summary).length === 0) {
                return Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠' });
            }

            let reportHtml = `<div class="max-h-[60vh] overflow-y-auto text-left space-y-2">`;
            const statusOrder = ['‡∏°‡∏≤', '‡∏•‡∏≤', '‡∏Ç‡∏≤‡∏î', '‡∏´‡∏ô‡∏µ'];

            for (const grade in summary) {
                for (const group in summary[grade]) {
                    for (const troop in summary[grade][group]) {
                        const data = summary[grade][group][troop];

                        // ----> [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤] <----
                        // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        const totalEnrolled = studentData[grade]?.[group]?.[troop]?.length || 0;

                        let statusText = statusOrder
                            .filter(status => data[status])
                            .map(status => `${status} ${data[status]}`)
                            .join(', ');
                        
                        // ----> [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] <----
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                        reportHtml += `
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="font-semibold text-green-800">${grade} ${group} ${troop}</div>
                                <div class="text-sm text-gray-600">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalEnrolled} ‡∏Ñ‡∏ô: ${statusText}</div>
                            </div>`;
                    }
                }
            }
            reportHtml += `</div>`;

            Swal.fire({
                title: '‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠',
                html: reportHtml,
                width: '600px',
                confirmButtonText: '‡∏õ‡∏¥‡∏î'
            });

        } catch (error) {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' });
        }
    }

        function confirmClearData(type) {
            Swal.fire({
                title: `‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${type === 'activity' ? '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' : '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠'}?`, text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#8b5cf6', confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (type === 'activity') {
                        activityRecords = [];
                        localStorage.removeItem('scoutActivityRecords');
                    } else {
                        attendanceRecords = [];
                        localStorage.removeItem('scoutAttendanceRecords');
                    }
                    Swal.fire({ icon: 'success', title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', confirmButtonColor: '#10b981' });
                }
            });
        }
    </script>
</body>
</html>
