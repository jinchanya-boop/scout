<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', sans-serif;
        }
        .gradient-bg {
            
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #ddd6fe 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .activity-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }
        .signature-pad {
            border: 2px dashed #c4b5fd;
            background: #faf5ff;
        }
        .rubric-item {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <header class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üèïÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏ç‡πà - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤</h1>
                        <p class="text-sm text-purple-600"> ‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ ‡∏°.1-‡∏°.3</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <select id="gradeSelect" class="px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="m1">‡∏°.1 - ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß</option>
                        <option value="m2">‡∏°.2 - ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ</option>
                        <option value="m3">‡∏°.3 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <button onclick="openStudentManagement()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-purple-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üë•</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                    </div>
                </div>
            </button>
            <button onclick="openAttendanceCheck()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-purple-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">‚úÖ</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                        <p class="text-sm text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    </div>
                </div>
            </button>
            <button onclick="showActivityReport()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-green-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìä</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                        <p class="text-sm text-gray-600">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                    </div>
                </div>
            </button>
            <button onclick="showAttendanceReport()" class="bg-white/90 backdrop-blur-md rounded-xl card-shadow p-4 hover:bg-blue-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìã</span>
                    <div class="text-left">
                        <h3 class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                        <p class="text-sm text-gray-600">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                    </div>
                </div>
            </button>
        </div>

        <div class="bg-white/90 backdrop-blur-md rounded-2xl card-shadow p-6 mb-8">
            <div class="flex items-center mb-6">
                <span class="text-2xl mr-3">üìÖ</span>
                <h2 class="text-2xl font-bold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏™</h2>
            </div>
            
            <div id="scheduleTable" class="overflow-x-auto">
                </div>
        </div>
    </main>

    <div id="studentManagementModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-purple-100">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üë•</span>
                    <h3 class="text-xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                </div>
                <button onclick="closeStudentManagement()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                    <select id="manageGrade" onchange="loadManageStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                        <option value="‡∏°.1">‡∏°.1</option>
                        <option value="‡∏°.2">‡∏°.2</option>
                        <option value="‡∏°.3">‡∏°.3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≠‡∏á</label>
                    <select id="manageGroup" onchange="loadManageStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á</option>
                        <option value="‡∏Å‡∏≠‡∏á1">‡∏Å‡∏≠‡∏á 1</option>
                        <option value="‡∏Å‡∏≠‡∏á2">‡∏Å‡∏≠‡∏á 2</option>
                        <option value="‡∏Å‡∏≠‡∏á3">‡∏Å‡∏≠‡∏á 3</option>
                        <option value="‡∏Å‡∏≠‡∏á4">‡∏Å‡∏≠‡∏á 4</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏π‡πà</label>
                    <select id="manageTroop" onchange="loadManageStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>
                        <option value="‡∏´‡∏°‡∏π‡πà1">‡∏´‡∏°‡∏π‡πà 1</option>
                        <option value="‡∏´‡∏°‡∏π‡πà2">‡∏´‡∏°‡∏π‡πà 2</option>
                        <option value="‡∏´‡∏°‡∏π‡πà3">‡∏´‡∏°‡∏π‡πà 3</option>
                        <option value="‡∏´‡∏°‡∏π‡πà4">‡∏´‡∏°‡∏π‡πà 4</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="showAddStudentForm()" class="w-full px-4 py-2 btn-primary text-white rounded-lg font-medium">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>

            <div id="studentForm" class="hidden mb-6 p-4 bg-purple-50 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-4" id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                <form id="addStudentForm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input type="text" id="studentFirstName" required class="w-full px-3 py-2 rounded-lg border" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="studentLastName" required class="w-full px-3 py-2 rounded-lg border" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <input type="text" id="studentId" required class="w-full px-3 py-2 rounded-lg border" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="hideStudentForm()" class="px-4 py-2 border rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 btn-primary text-white rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>

            <div id="manageStudentList">
                <div class="text-center text-gray-500 py-8">
                    <span class="text-4xl block mb-2">üë•</span>
                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
            </div>
        </div>
    </div>
</div>

    <div id="attendanceModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-purple-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">‚úÖ</span>
                        <h3 class="text-xl font-bold text-gray-800">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                    </div>
                    <button onclick="closeAttendanceCheck()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="attendanceDate" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <select id="attendanceActivity" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                            <option value="‡πÄ‡∏ä‡πâ‡∏≤">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ä‡πâ‡∏≤</option>
                            <option value="‡∏™‡∏≤‡∏¢">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≤‡∏¢</option>
                            <option value="‡∏ö‡πà‡∏≤‡∏¢">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡πà‡∏≤‡∏¢</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                    <select id="attendanceGrade" onchange="loadAttendanceStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                        <option value="‡∏°.1">‡∏°.1</option>
                        <option value="‡∏°.2">‡∏°.2</option>
                        <option value="‡∏°.3">‡∏°.3</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≠‡∏á</label>
                        <select id="attendanceGroup" onchange="updateAttendanceTroopOptions()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á</option>
                            <option value="‡∏Å‡∏≠‡∏á1">‡∏Å‡∏≠‡∏á 1</option>
                            <option value="‡∏Å‡∏≠‡∏á2">‡∏Å‡∏≠‡∏á 2</option>
                            <option value="‡∏Å‡∏≠‡∏á3">‡∏Å‡∏≠‡∏á 3</option>
                            <option value="‡∏Å‡∏≠‡∏á4">‡∏Å‡∏≠‡∏á 4</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏π‡πà</label>
                        <select id="attendanceTroop" onchange="loadAttendanceStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>
                        </select>
                    </div>
                </div>

                <div id="attendanceStudentList">
                    <div class="text-center text-gray-500 py-8">
                        <span class="text-4xl block mb-2">‚úÖ</span>
                        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button onclick="saveAttendance()" class="px-6 py-2 btn-primary text-white rounded-lg font-medium">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="activityModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        
        <div class="p-6 border-b border-purple-100">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üìù</span>
                    <h3 class="text-xl font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                </div>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
        </div>

        <div class="p-6">
            <form id="activityForm">
                
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üïê ‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input type="text" id="activityTime" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <input type="text" id="activityName" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" readonly>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üë• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="activityGrade" onchange="loadStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">‡∏Å‡∏≠‡∏á</label>
                            <select id="selectedGroup" onchange="updateActivityTroopOptions()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á</option>
                                <option value="‡∏Å‡∏≠‡∏á1">‡∏Å‡∏≠‡∏á 1</option>
                                <option value="‡∏Å‡∏≠‡∏á2">‡∏Å‡∏≠‡∏á 2</option>
                                <option value="‡∏Å‡∏≠‡∏á3">‡∏Å‡∏≠‡∏á 3</option>
                                <option value="‡∏Å‡∏≠‡∏á4">‡∏Å‡∏≠‡∏á 4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">‡∏´‡∏°‡∏π‡πà</label>
                            <select id="selectedTroop" onchange="loadStudentList()" class="w-full px-3 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" disabled>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="studentAttendanceList" class="hidden">
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-800 mb-3 flex items-center">
                                <span class="mr-2">üìã</span>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                            </h4>
                            <div id="studentCheckList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="attendanceSummary" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
                    <h5 class="font-semibold text-gray-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</h5>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
                        <span class="font-medium">‚úÖ ‡∏°‡∏≤: <span id="summaryPresent" class="text-green-600 font-bold">0</span> ‡∏Ñ‡∏ô</span>
                        <span class="font-medium">üìã ‡∏•‡∏≤: <span id="summaryLeave" class="text-yellow-600 font-bold">0</span> ‡∏Ñ‡∏ô</span>
                        <span class="font-medium">‚ùå ‡∏Ç‡∏≤‡∏î: <span id="summaryAbsent" class="text-red-600 font-bold">0</span> ‡∏Ñ‡∏ô</span>
                        <span class="font-medium">üèÉ ‡∏´‡∏ô‡∏µ: <span id="summarySkipped" class="text-orange-600 font-bold">0</span> ‡∏Ñ‡∏ô</span>
                    </div>
                </div>

                <div class="mb-6 mt-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">‚≠ê</span>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                    </h4>
                    <div class="space-y-3" id="rubricItems"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</label>
                        <input type="number" id="totalScore" min="0" max="100" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" placeholder="0-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìä ‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <select id="gradeLevel" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                            <option value="‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°">‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (90-100)</option>
                            <option value="‡∏î‡∏µ‡∏°‡∏≤‡∏Å">‡∏î‡∏µ‡∏°‡∏≤‡∏Å (80-89)</option>
                            <option value="‡∏î‡∏µ">‡∏î‡∏µ (70-79)</option>
                            <option value="‡∏û‡∏≠‡πÉ‡∏ä‡πâ">‡∏û‡∏≠‡πÉ‡∏ä‡πâ (60-69)</option>
                            <option value="‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (&lt;60)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ó‡πå</label>
                    <textarea id="comments" rows="4" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</label>
                    <textarea id="notes" rows="3" class="w-full px-4 py-2 rounded-lg border border-purple-200 focus:ring-2 focus:ring-purple-500" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‚úçÔ∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</label>
                    <div class="signature-pad rounded-lg p-4 text-center">
                        <canvas id="signatureCanvas" width="300" height="100" class="border-2 border-dashed border-purple-300 rounded-lg mx-auto cursor-crosshair"></canvas>
                        <div class="mt-2 space-x-2">
                            <button type="button" onclick="clearSignature()" class="text-sm text-purple-600 hover:text-purple-800">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="px-6 py-2 btn-primary text-white rounded-lg font-medium">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    <script>
        // #############################################################################
        // #                            CONFIGURATION                                  #
        // #############################################################################
        
        // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_V2hmixpjY3JEv_u1yLThuAWyj5jiUL5mg8bT0Nafc7r5nT2onTOLB_zjIHzOumOV/exec'
        
        // #############################################################################
        // #                            GLOBAL VARIABLES                               #
        // #############################################################################
        
        let studentData = {};
        let editingStudent = null;
        let canvas, ctx, isDrawing = false;
        let activityRecords = JSON.parse(localStorage.getItem('scoutActivityRecords') || '[]');
        let attendanceRecords = JSON.parse(localStorage.getItem('scoutAttendanceRecords') || '[]');

        const scheduleData = {
            m1: {
                title: "‡∏°.1 - ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß",
                focus: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‚Äì ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‚Äì ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏ò‡∏á‡∏ä‡∏≤‡∏ï‡∏¥", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (2‚Äì3 ‡∏Å‡∏°.)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ö‡∏≤‡∏î‡πÅ‡∏ú‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏û‡∏¥‡∏£‡∏≠‡∏î, ‡∏ï‡∏∞‡∏Å‡∏£‡∏∏‡∏î‡πÄ‡∏ö‡πá‡∏î, ‡∏Ç‡∏±‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥)", day2: "‡∏ù‡∏∂‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®", day3: "‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡πÑ‡∏ü‡∏á‡πà‡∏≤‡∏¢ ‡πÜ" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡πÄ‡∏Å‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Teamwork", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ú‡∏π‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏ú‡∏π‡πâ‡∏ï‡∏≤‡∏°", day2: "‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠", day3: "‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î (Reflection)" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            },
            m2: {
                title: "‡∏°.2 - ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
                focus: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‚Äì ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå ‚Äì ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡∏à‡∏£‡∏¥‡∏á ‚Äì ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏°‡∏π‡πà, ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (4‚Äì5 ‡∏Å‡∏°.)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î, ‡∏´‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö)" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå (‡∏ö‡πà‡∏ß‡∏á‡∏™‡∏≤‡∏¢‡∏ò‡∏ô‡∏π, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤)", day2: "‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ / ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", day3: "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏ú‡∏π‡πâ‡∏ï‡∏≤‡∏°", day2: "‡∏ê‡∏≤‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏à/Team Building", day3: "‡πÄ‡∏Å‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡∏ä‡∏∏‡∏°‡∏ä‡∏ô/‡∏ß‡∏±‡∏î)", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏® + ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°", day2: "‡πÄ‡∏û‡∏•‡∏á‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            },
            m3: {
                title: "‡∏°.3 - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î",
                focus: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ ‚Äì ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‚Äì ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î ‚Äì ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ",
                schedule: [
                    { time: "08.30 ‚Äì 09.00", day1: "‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á" },
                    { time: "09.00 ‚Äì 10.00", day1: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤ (‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà)", day2: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• (6‚Äì8 ‡∏Å‡∏°. + ‡∏ê‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á)", day3: "‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏î‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å, ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢)" },
                    { time: "10.00 ‚Äì 10.15", day1: "‡∏û‡∏±‡∏Å", day2: "‡∏û‡∏±‡∏Å", day3: "‡∏û‡∏±‡∏Å" },
                    { time: "10.15 ‚Äì 11.15", day1: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡∏π‡∏Å‡∏£‡∏≠‡∏Å, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏≠)", day2: "‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô / ‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô", day3: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î (‡∏´‡∏≤‡∏ô‡πâ‡∏≥, ‡∏´‡∏≤‡∏ó‡∏¥‡∏®‡∏à‡∏≤‡∏Å‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß)" },
                    { time: "11.15 ‚Äì 12.00", day1: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (‡∏ù‡∏∂‡∏Å‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å)", day2: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ê‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢", day3: "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.3 ‡∏à‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á ‡∏°.1‚Äì‡∏°.2" },
                    { time: "12.00 ‚Äì 13.00", day1: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day2: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", day3: "‡∏û‡∏±‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" },
                    { time: "13.00 ‚Äì 14.30", day1: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", day2: "‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏•‡πá‡∏Å ‡πÜ)", day3: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏£‡∏ß‡∏° (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô + ‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏® + ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• + ‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥)" },
                    { time: "14.30 ‚Äì 15.30", day1: "‡πÄ‡∏Å‡∏°‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à", day2: "‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå (Mini Camp Fire)", day3: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î" },
                    { time: "15.30 ‚Äì 16.00", day1: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day2: "‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", day3: "‡∏û‡∏¥‡∏ò‡∏µ‡∏õ‡∏¥‡∏î + ‡∏°‡∏≠‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£" }
                ]
            }
        };

        const rubricCriteria = {
            default: [
                { criteria: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", maxScore: 25 }, { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏ó‡∏µ‡∏°", maxScore: 25 },
                { criteria: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö", maxScore: 25 }, { criteria: "‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", maxScore: 25 }
            ],
            skill: [
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ", maxScore: 30 }, { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", maxScore: 25 },
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", maxScore: 25 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á", maxScore: 20 }
            ],
            leadership: [
                { criteria: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥", maxScore: 30 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", maxScore: 25 },
                { criteria: "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à", maxScore: 25 }, { criteria: "‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", maxScore: 20 }
            ]
        };

        // #############################################################################
        // #                            INITIALIZATION                                 #
        // #############################################################################
        
        document.addEventListener('DOMContentLoaded', function () {
            fetchStudents();
            setupSignatureCanvas();
            document.getElementById('gradeSelect').addEventListener('change', loadSchedule);
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addStudentForm').addEventListener('submit', (e) => { e.preventDefault(); saveStudent(); });
            document.getElementById('activityForm').addEventListener('submit', (e) => { e.preventDefault(); saveActivityRecord(); });
        });

        // #############################################################################
        // #                            DATA HANDLING                                  #
        // #############################################################################

        async function fetchStudents() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getStudents');
                if (!response.ok) throw new Error('Network response was not ok');
                studentData = await response.json();
                console.log('Student data loaded successfully:', studentData);
            } catch (error) {
                console.error('Failed to fetch students:', error);
                Swal.fire({
                    icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script',
                    confirmButtonColor: '#8b5cf6'
                });
            } finally {
                loadSchedule(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            }
        }

        async function postData(payload) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Unknown error from server');
                return result;
            } catch (error) {
                console.error('Error posting data:', error);
                throw error;
            }
        }
        
        // #############################################################################
        // #                         STUDENT MANAGEMENT                                #
        // #############################################################################

        async function saveStudent() {
            const group = document.getElementById('manageGroup').value;
            const troop = document.getElementById('manageTroop').value;
            const firstName = document.getElementById('studentFirstName').value.trim();
            const lastName = document.getElementById('studentLastName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();

            if (!firstName || !lastName || !studentId) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', confirmButtonColor: '#8b5cf6' });
                return;
            }

            const studentObj = { id: studentId, firstName, lastName, group, troop };
            const payload = {
                type: 'manageStudent',
                action: editingStudent ? 'edit' : 'add',
                student: studentObj,
                ...(editingStudent && { originalId: editingStudent.originalId })
            };

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });

            try {
                await postData(payload);

                // Update local data for immediate UI feedback
                if (editingStudent) {
                    const oldStudentList = studentData[editingStudent.group]?.[editingStudent.troop] || [];
                    const studentIndex = oldStudentList.findIndex(s => s.id === editingStudent.originalId);
                    if (studentIndex > -1) oldStudentList.splice(studentIndex, 1);
                }
                if (!studentData[group]) studentData[group] = {};
                if (!studentData[group][troop]) studentData[group][troop] = [];
                studentData[group][troop].push({ id: studentId, firstName, lastName });

                hideStudentForm();
                loadManageStudentList();
                Swal.fire({ icon: 'success', title: editingStudent ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', confirmButtonColor: '#8b5cf6' });
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, confirmButtonColor: '#ef4444' });
            }
        }
        
        function editStudent(group, troop, index) {
            const student = studentData[group]?.[troop]?.[index];
            if (!student) return;
            editingStudent = { group, troop, index, originalId: student.id };
            document.getElementById('formTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            document.getElementById('studentFirstName').value = student.firstName;
            document.getElementById('studentLastName').value = student.lastName;
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentForm').classList.remove('hidden');
        }

        function deleteStudent(group, troop, index) {
            const student = studentData[group]?.[troop]?.[index];
            if (!student) return;

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${student.firstName} ${student.lastName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#8b5cf6', confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });
                    try {
                        await postData({ type: 'manageStudent', action: 'delete', student: { id: student.id } });
                        studentData[group][troop].splice(index, 1);
                        loadManageStudentList();
                        Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', confirmButtonColor: '#8b5cf6' });
                    } catch (error) {
                        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, confirmButtonColor: '#ef4444' });
                    }
                }
            });
        }
        
        // #############################################################################
        // #                         ACTIVITY & ATTENDANCE                             #
        // #############################################################################
        
        async function saveActivityRecord() {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });
    
    const rubricScores = {};
    document.querySelectorAll('[id^="rubric_"]').forEach((item, index) => {
        rubricScores[`criteria_${index}`] = item.value;
    });

    const payload = {
        type: 'activity',
        timestamp: new Date().toLocaleString('th-TH'),
        grade: document.getElementById('gradeSelect').value,
        time: document.getElementById('activityTime').value,
        activity: document.getElementById('activityName').value,
        selectedGroup: document.getElementById('selectedGroup').value,
        selectedTroop: document.getElementById('selectedTroop').value,
        totalScore: document.getElementById('totalScore').value,
        gradeLevel: document.getElementById('gradeLevel').value,
        comments: document.getElementById('comments').value,
        notes: document.getElementById('notes').value,
        signature: canvas.toDataURL(),
        rubricScores,
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
        summaryPresent: document.getElementById('summaryPresent').innerText,
        summaryLeave: document.getElementById('summaryLeave').innerText,
        summaryAbsent: document.getElementById('summaryAbsent').innerText,
        summarySkipped: document.getElementById('summarySkipped').innerText
    };

    try {
        await postData(payload);
        saveDataLocally(payload);
        showSuccessMessage(payload, false);
    } catch (error) {
        saveDataLocally(payload);
        showSuccessMessage(payload, true);
    }
}
        
        async function saveAttendance() {
    const date = document.getElementById('attendanceDate').value;
    const activity = document.getElementById('attendanceActivity').value;
    const group = document.getElementById('attendanceGroup').value;
    const troop = document.getElementById('attendanceTroop').value;
    const grade = document.getElementById('attendanceGrade').value; // <-- ‡πÄ‡∏£‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ grade ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß

    if (!date || !activity || !grade || !group || !troop) { // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° grade ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', confirmButtonColor: '#8b5cf6' });
        return;
    }

    const students = studentData[grade]?.[group]?.[troop] || [];

    if (students.length === 0) {
        Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ', confirmButtonColor: '#8b5cf6' });
        return;
    }

    const attendanceData = students.map(student => ({
        studentId: student.id,
        studentName: `${student.firstName} ${student.lastName}`,
        status: document.querySelector(`input[name="attendance_${student.id}"]:checked`)?.value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    }));

    // ----> ‡πÄ‡∏û‡∏¥‡πà‡∏° grade ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô payload ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á <----
    const payload = { type: 'attendance', timestamp: new Date().toLocaleString('th-TH'), date, activity, grade, group, troop, attendanceData };

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });

    try {
        await postData(payload);
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ...
        closeAttendanceCheck();
        Swal.fire({
            icon: 'success', 
            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            html: `<div class="text-left"><p><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> ${payload.grade} / ${payload.group} / ${payload.troop}</p></div><div class="mt-4 p-3 bg-green-100 rounded-lg text-sm">‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß</div>`,
            confirmButtonColor: '#8b5cf6'
        });
  

        } catch (error) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Local Storage ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const records = JSON.parse(localStorage.getItem('scoutAttendanceRecords') || '[]');
            records.push(payload);
            localStorage.setItem('scoutAttendanceRecords', JSON.stringify(records));

            closeAttendanceCheck();
            Swal.fire({
                icon: 'warning', 
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                html: `<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p><div class="mt-4 p-3 bg-yellow-100 rounded-lg text-sm">‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>`,
                confirmButtonColor: '#8b5cf6'
            });
            console.error('Failed to save attendance to Sheet:', error);
        }
    }
        
        // #############################################################################
        // #                             UI & DISPLAY                                  #
        // #############################################################################

        function loadSchedule() {
            const selectedGrade = document.getElementById('gradeSelect').value;
            const data = scheduleData[selectedGrade];
            const tableContainer = document.getElementById('scheduleTable');
            
            let html = `
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-purple-800">${data.title}</h3>
                    <p class="text-sm text-gray-600 mt-1"><strong>‡∏à‡∏∏‡∏î‡πÄ‡∏ô‡πâ‡∏ô:</strong> ${data.focus}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á</th>
                                <th class="border border-purple-300 px-4 py-3 text-left font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            data.schedule.forEach((row) => {
                const isBreak = row.day1.includes('‡∏û‡∏±‡∏Å');
                const btn = (day, activity) => !isBreak ? `<button onclick="openActivityModal('${row.time}', '${activity.replace(/'/g, "\\'")}', ${day})" class="ml-2 px-3 py-1 bg-purple-500 text-white text-xs rounded-full hover:bg-purple-600 transition-colors">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>` : '';
                html += `
                    <tr class="${isBreak ? 'bg-purple-50' : 'bg-white hover:bg-purple-50'} transition-colors">
                        <td class="border border-purple-200 px-4 py-3 font-medium text-purple-700">${row.time}</td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day1}</span>${btn(1, row.day1)}</div></td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day2}</span>${btn(2, row.day2)}</div></td>
                        <td class="border border-purple-200 px-4 py-3"><div class="flex items-center justify-between"><span>${row.day3}</span>${btn(3, row.day3)}</div></td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>`;
            tableContainer.innerHTML = html;
        }
        
        function loadManageStudentList() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    const container = document.getElementById('manageStudentList');
    
    // ‡πÉ‡∏ä‡πâ optional chaining (?.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏´‡∏≤‡∏Å object level ‡πÉ‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ
    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = `
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-gray-800 mb-3">${grade} / ${group} / ${troop} - ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${students.length} ‡∏Ñ‡∏ô)</h4>
            </div>
            <div class="space-y-3">`;
        
        if (students.length > 0) {
            students.forEach((student, index) => {
                html += `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-purple-600 font-medium">${index + 1}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.firstName} ${student.lastName}</div>
                                <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${student.id}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editStudent('${grade}', '${group}', '${troop}', ${index})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteStudent('${grade}', '${group}', '${troop}', ${index})" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg">üóëÔ∏è ‡∏•‡∏ö</button>
                        </div>
                    </div>`;
            });
        } else {
            html += `<p class="text-center text-gray-500">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }

        html += '</div>';
        container.innerHTML = html;
    } else {
        container.innerHTML = `<div class="text-center text-gray-500 py-8"><span class="text-4xl block mb-2">üë•</span><p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p></div>`;
    }
}

function showAddStudentForm() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    
    if (!grade || !group || !troop) {
        Swal.fire({
            icon: 'warning',
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',
            text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
            confirmButtonColor: '#8b5cf6'
        });
        return;
    }
    
    editingStudent = null;
    document.getElementById('formTitle').textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (${grade} / ${group} / ${troop})`;
    document.getElementById('addStudentForm').reset();
    document.getElementById('studentForm').classList.remove('hidden');
}

async function saveStudent() {
    const grade = document.getElementById('manageGrade').value;
    const group = document.getElementById('manageGroup').value;
    const troop = document.getElementById('manageTroop').value;
    const firstName = document.getElementById('studentFirstName').value.trim();
    const lastName = document.getElementById('studentLastName').value.trim();
    const studentId = document.getElementById('studentId').value.trim();

    const studentObj = { id: studentId, firstName, lastName, grade, group, troop };
    const payload = {
        type: 'manageStudent',
        action: editingStudent ? 'edit' : 'add',
        student: studentObj,
        ...(editingStudent && { originalId: editingStudent.originalId })
    };

    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', willOpen: () => Swal.showLoading() });

    try {
        await postData(payload);

        // Update local data
        if (editingStudent) {
            const oldList = studentData[editingStudent.grade]?.[editingStudent.group]?.[editingStudent.troop] || [];
            const studentIndex = oldList.findIndex(s => s.id === editingStudent.originalId);
            if (studentIndex > -1) oldList.splice(studentIndex, 1);
        }
        if (!studentData[grade]) studentData[grade] = {};
        if (!studentData[grade][group]) studentData[grade][group] = {};
        if (!studentData[grade][group][troop]) studentData[grade][group][troop] = [];
        studentData[grade][group][troop].push({ id: studentId, firstName, lastName });

        hideStudentForm();
        loadManageStudentList();
        Swal.fire({ icon: 'success', title: editingStudent ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    } catch (error) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message });
    }
}

function editStudent(grade, group, troop, index) {
    const student = studentData[grade]?.[group]?.[troop]?.[index];
    if (!student) return;
    editingStudent = { grade, group, troop, index, originalId: student.id };
    
    document.getElementById('formTitle').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${grade}/${group}/${troop})`;
    document.getElementById('studentFirstName').value = student.firstName;
    document.getElementById('studentLastName').value = student.lastName;
    document.getElementById('studentId').value = student.id;
    document.getElementById('studentForm').classList.remove('hidden');
}

function deleteStudent(grade, group, troop, index) {
    const student = studentData[grade]?.[group]?.[troop]?.[index];
    if (!student) return;

    Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${student.firstName} ${student.lastName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', willOpen: () => Swal.showLoading() });
            try {
                await postData({ type: 'manageStudent', action: 'delete', student: { id: student.id } });
                studentData[grade][group][troop].splice(index, 1);
                loadManageStudentList();
                Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message });
            }
        }
    });
}
        
        function loadAttendanceStudentList() {
    const grade = document.getElementById('attendanceGrade').value; //  <-- ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
    const group = document.getElementById('attendanceGroup').value;
    const troop = document.getElementById('attendanceTroop').value;
    const container = document.getElementById('attendanceStudentList');

    // ‡πÉ‡∏ä‡πâ optional chaining (?.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô > ‡∏Å‡∏≠‡∏á > ‡∏´‡∏°‡∏π‡πà
    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = `
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-gray-800">${grade} / ${group} / ${troop} - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (${students.length} ‡∏Ñ‡∏ô)</h4>
            </div>
            <div class="space-y-3">`;
        
        if (students.length > 0) {
            students.forEach(student => {
                html += `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-purple-600 font-medium">${student.firstName.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.firstName} ${student.lastName}</div>
                                <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${student.id}</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-x-3 gap-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏°‡∏≤" class="text-green-600" checked><span class="text-sm font-medium">‚úÖ ‡∏°‡∏≤</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏•‡∏≤" class="text-yellow-600"><span class="text-sm font-medium">üìã ‡∏•‡∏≤</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏Ç‡∏≤‡∏î" class="text-red-600"><span class="text-sm font-medium">‚ùå ‡∏Ç‡∏≤‡∏î</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="attendance_${student.id}" value="‡∏´‡∏ô‡∏µ" class="text-orange-600"><span class="text-sm font-medium">üèÉ ‡∏´‡∏ô‡∏µ</span></label>
                        </div>
                    </div>`;
            });
        } else {
             html += `<p class="text-center text-gray-500 py-4">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    } else {
        container.innerHTML = `<div class="text-center text-gray-500 py-8"><span class="text-4xl block mb-2">‚úÖ</span><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p></div>`;
    }
}
        
        // #############################################################################
        // #                           UTILITY FUNCTIONS                               #
        // #############################################################################
        
        function updateTroopOptions(groupElId, troopElId) {
            const groupSelect = document.getElementById(groupElId);
            const troopSelect = document.getElementById(troopElId);
            troopSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>';
            if (groupSelect.value) {
                for (let i = 1; i <= 4; i++) {
                    troopSelect.innerHTML += `<option value="‡∏´‡∏°‡∏π‡πà${i}">‡∏´‡∏°‡∏π‡πà ${i}</option>`;
                }
            }
        }
        function updateManageTroopOptions() { updateTroopOptions('manageGroup', 'manageTroop'); }
        function updateAttendanceTroopOptions() { updateTroopOptions('attendanceGroup', 'attendanceTroop'); }
        function updateActivityTroopOptions() { 
            updateTroopOptions('selectedGroup', 'selectedTroop');
            document.getElementById('selectedTroop').disabled = !document.getElementById('selectedGroup').value;
        }

        function loadStudentList() {
    const grade = document.getElementById('activityGrade').value;
    const group = document.getElementById('selectedGroup').value;
    const troop = document.getElementById('selectedTroop').value;
    const container = document.getElementById('studentCheckList');
    const wrapper = document.getElementById('studentAttendanceList');
    const summaryWrapper = document.getElementById('attendanceSummary'); // <-- ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ

    const students = studentData[grade]?.[group]?.[troop] || [];
    
    if (grade && group && troop) {
        let html = '';
        if (students.length > 0) {
            students.forEach(student => {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° onchange="updateAttendanceSummary()" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô input ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
                html += `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200">
                        <div class="flex items-center space-x-3">
                            <span class="font-medium text-gray-800">${student.firstName} ${student.lastName}</span>
                            <span class="text-sm text-gray-500">(${student.id})</span>
                        </div>
                        <div class="flex space-x-2">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏°‡∏≤" class="text-green-600" checked>
                                <span class="text-sm">‡∏°‡∏≤</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏•‡∏≤" class="text-yellow-600">
                                <span class="text-sm">‡∏•‡∏≤</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏Ç‡∏≤‡∏î" class="text-red-600">
                                <span class="text-sm">‡∏Ç‡∏≤‡∏î</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" onchange="updateAttendanceSummary()" name="activity_attendance_${student.id}" value="‡∏´‡∏ô‡∏µ" class="text-orange-600">
                                <span class="text-sm">‡∏´‡∏ô‡∏µ</span>
                            </label>
                        </div>
                    </div>
                `;
            });
        } else {
            html = `<p class="text-center text-gray-500 py-2">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</p>`;
        }
        
        container.innerHTML = html;
        wrapper.classList.remove('hidden');
        summaryWrapper.classList.remove('hidden'); // <-- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        updateAttendanceSummary(); 

    } else {
        container.innerHTML = ''; 
        wrapper.classList.add('hidden');
        summaryWrapper.classList.add('hidden'); // <-- ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    }
}
        function updateAttendanceSummary() {
    const container = document.getElementById('studentCheckList');
    if (!container) return;

    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å radio button ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const presentCount = container.querySelectorAll('input[value="‡∏°‡∏≤"]:checked').length;
    const leaveCount = container.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length;
    const absentCount = container.querySelectorAll('input[value="‡∏Ç‡∏≤‡∏î"]:checked').length;
    const skippedCount = container.querySelectorAll('input[value="‡∏´‡∏ô‡∏µ"]:checked').length;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ
    document.getElementById('summaryPresent').innerText = presentCount;
    document.getElementById('summaryLeave').innerText = leaveCount;
    document.getElementById('summaryAbsent').innerText = absentCount;
    document.getElementById('summarySkipped').innerText = skippedCount;
}

        // --- MODAL & FORM VISIBILITY ---
        function openStudentManagement() { document.getElementById('studentManagementModal').classList.remove('hidden'); }
        function closeStudentManagement() { document.getElementById('studentManagementModal').classList.add('hidden'); hideStudentForm(); }
        function openAttendanceCheck() { document.getElementById('attendanceModal').classList.remove('hidden'); }
        function closeAttendanceCheck() { document.getElementById('attendanceModal').classList.add('hidden'); }
        function closeModal() { document.getElementById('activityModal').classList.add('hidden'); document.getElementById('activityForm').reset(); clearSignature(); }
        function hideStudentForm() { document.getElementById('studentForm').classList.add('hidden'); editingStudent = null; document.getElementById('addStudentForm').reset(); }
        function showAddStudentForm() {
            if (!document.getElementById('manageGroup').value || !document.getElementById('manageTroop').value) {
                Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô', confirmButtonColor: '#8b5cf6' });
                return;
            }
            editingStudent = null;
            document.getElementById('formTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('addStudentForm').reset();
            document.getElementById('studentForm').classList.remove('hidden');
        }

        // --- ACTIVITY MODAL & RUBRIC ---
        function openActivityModal(time, activity, day) {
            document.getElementById('activityTime').value = time;
            document.getElementById('activityName').value = activity;
            let criteriaKey = 'default';
            if (['‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô', '‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®', '‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'].some(s => activity.includes(s))) criteriaKey = 'skill';
            else if (['‡∏ú‡∏π‡πâ‡∏ô‡∏≥', '‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤'].some(s => activity.includes(s))) criteriaKey = 'leadership';
            loadRubricItems(rubricCriteria[criteriaKey]);
            document.getElementById('activityModal').classList.remove('hidden');
        }

        function loadRubricItems(criteria) {
            const container = document.getElementById('rubricItems');
            container.innerHTML = criteria.map((item, index) => `
                <div class="rubric-item rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-800">${item.criteria}</span>
                        <span class="text-sm text-purple-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°: ${item.maxScore}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="range" min="0" max="${item.maxScore}" value="0" class="flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer" id="rubric_${index}" oninput="updateRubricScore()">
                        <span id="score_${index}" class="font-bold text-purple-600 min-w-[60px]">0/${item.maxScore}</span>
                    </div>
                </div>`).join('');
            updateRubricScore(); // Set initial total score to 0
        }

        function updateRubricScore() {
            let total = 0;
            document.querySelectorAll('[id^="rubric_"]').forEach((item, index) => {
                const value = parseInt(item.value);
                const maxScore = parseInt(item.max);
                document.getElementById(`score_${index}`).textContent = `${value}/${maxScore}`;
                total += value;
            });
            document.getElementById('totalScore').value = total;
            const gradeSelect = document.getElementById('gradeLevel');
            if (total >= 90) gradeSelect.value = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
            else if (total >= 80) gradeSelect.value = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
            else if (total >= 70) gradeSelect.value = '‡∏î‡∏µ';
            else if (total >= 60) gradeSelect.value = '‡∏û‡∏≠‡πÉ‡∏ä‡πâ';
            else gradeSelect.value = '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
        }

        // --- SIGNATURE CANVAS ---
        function setupSignatureCanvas() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            clearSignature();
            ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDraw));
            ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, draw));
            ['mouseup', 'mouseout', 'touchend'].forEach(evt => canvas.addEventListener(evt, stopDraw));
        }
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches?.[0];
            return [ (e.clientX || touch.clientX) - rect.left, (e.clientY || touch.clientY) - rect.top ];
        }
        function startDraw(e) { e.preventDefault(); isDrawing = true; [ctx.lastX, ctx.lastY] = getCoords(e); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); drawLine(...getCoords(e)); }
        function stopDraw() { isDrawing = false; }
        function drawLine(x, y) {
            ctx.beginPath();
            ctx.moveTo(ctx.lastX, ctx.lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
            [ctx.lastX, ctx.lastY] = [x, y];
        }
        function clearSignature() { ctx.fillStyle = '#faf5ff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }

        // --- LOCAL STORAGE & REPORTS ---
        function saveDataLocally(data) {
            try {
                const records = data.type === 'attendance' ? attendanceRecords : activityRecords;
                const key = data.type === 'attendance' ? 'scoutAttendanceRecords' : 'scoutActivityRecords';
                records.push(data);
                localStorage.setItem(key, JSON.stringify(records));
            } catch (error) { console.error('Error saving locally:', error); }
        }

        function showSuccessMessage(data, isOffline = false) {
            const commonProps = { confirmButtonColor: '#8b5cf6', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' };
            const statusHtml = `<div class="mt-4 p-3 ${isOffline ? 'bg-yellow-100' : 'bg-green-100'} rounded-lg text-sm">${isOffline ? '‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' : '‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß'}</div>`;
            if (data.type === 'attendance') {
                closeAttendanceCheck();
                Swal.fire({
                    ...commonProps, icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
                    html: `<div class="text-left"><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.date}</p><p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${data.activity}</p><p><strong>‡∏Å‡∏≠‡∏á-‡∏´‡∏°‡∏π‡πà:</strong> ${data.group} ${data.troop}</p></div>` + statusHtml,
                });
            } else {
                closeModal();
                Swal.fire({
                    ...commonProps, icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
                    html: `<div class="text-left"><p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${data.activity}</p><p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> ${data.totalScore}/100</p><p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${data.gradeLevel}</p></div>` + statusHtml,
                });
            }
        }
        
        async function showActivityReport() {
    Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        const response = await fetch(SCRIPT_URL + '?action=getActivitySummary');
        const summary = await response.json();

        if (Object.keys(summary).length === 0) {
            return Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', confirmButtonColor: '#8b5cf6' });
        }

        let reportHtml = `<div class="max-h-[70vh] overflow-y-auto text-left space-y-2">`;
        
        // Loop ‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
        for (const gradeName in summary) {
            const gradeData = summary[gradeName];
            const gradeAvg = (gradeData.totalScore / gradeData.count).toFixed(2);

            reportHtml += `
                <details class="bg-gray-100 rounded-xl border border-gray-300 overflow-hidden">
                    <summary class="p-4 font-bold text-xl text-gray-800 cursor-pointer flex justify-between hover:bg-gray-200">
                        <span>${gradeName.toUpperCase()}</span>
                        <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°: ${gradeAvg}</span>
                    </summary>
                    <div class="px-4 py-2 border-t border-gray-300 space-y-3">`;

            // Loop ‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡∏Å‡∏≠‡∏á
            for (const groupName in gradeData.groups) {
                const groupData = gradeData.groups[groupName];
                const groupAvg = (groupData.totalScore / groupData.count).toFixed(2);
                
                reportHtml += `
                    <details class="bg-purple-50 rounded-lg border border-purple-200">
                        <summary class="p-3 font-semibold text-lg text-purple-800 cursor-pointer flex justify-between hover:bg-purple-100">
                            <span>${groupName}</span>
                            <span>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${groupAvg}</span>
                        </summary>
                        <div class="p-3 border-t border-purple-200 space-y-2">`;
                
                // Loop ‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏™‡∏∏‡∏î: ‡∏´‡∏°‡∏π‡πà
                for (const troopName in groupData.troops) {
                    const troopData = groupData.troops[troopName];
                    const troopAvg = (troopData.totalScore / troopData.count).toFixed(2);
                    
                    const activitiesHtml = troopData.activities.map(act => `
                        <div class="flex justify-between text-sm py-1 pl-4 text-gray-600">
                            <span>- ${act.name}</span>
                            <span>${act.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </div>
                    `).join('');

                    reportHtml += `
                        <details class="bg-white rounded-md border">
                            <summary class="p-2 font-medium cursor-pointer flex justify-between text-gray-800 text-base">
                                <span>${troopName}</span>
                                <span class="text-sm">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${troopAvg} (${troopData.count} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)</span>
                            </summary>
                            <div class="px-2 pb-1 border-t">${activitiesHtml}</div>
                        </details>`;
                }
                
                reportHtml += `</div></details>`;
            }
            
            reportHtml += `</div></details>`;
        }
        
        reportHtml += '</div>';
        
        Swal.fire({
            title: 'üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
            html: reportHtml,
            width: '800px',
            confirmButtonText: '‡∏õ‡∏¥‡∏î',
            confirmButtonColor: '#8b5cf6'
        });

    } catch (error) {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' });
        console.error(error);
    }
}

async function showAttendanceReport() {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ...', didOpen: () => Swal.showLoading() });

        try {
            const response = await fetch(SCRIPT_URL + '?action=getAttendanceSummary');
            const summary = await response.json();

            if (Object.keys(summary).length === 0) {
                return Swal.fire({ icon: 'info', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠' });
            }

            let reportHtml = `<div class="max-h-[60vh] overflow-y-auto text-left space-y-2">`;
            const statusOrder = ['‡∏°‡∏≤', '‡∏•‡∏≤', '‡∏Ç‡∏≤‡∏î', '‡∏´‡∏ô‡∏µ'];

            for (const grade in summary) {
                for (const group in summary[grade]) {
                    for (const troop in summary[grade][group]) {
                        const data = summary[grade][group][troop];

                        // ----> [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤] <----
                        // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        const totalEnrolled = studentData[grade]?.[group]?.[troop]?.length || 0;

                        let statusText = statusOrder
                            .filter(status => data[status])
                            .map(status => `${status} ${data[status]}`)
                            .join(', ');
                        
                        // ----> [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] <----
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                        reportHtml += `
                            <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="font-semibold text-green-800">${grade} ${group} ${troop}</div>
                                <div class="text-sm text-gray-600">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalEnrolled} ‡∏Ñ‡∏ô: ${statusText}</div>
                            </div>`;
                    }
                }
            }
            reportHtml += `</div>`;

            Swal.fire({
                title: '‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠',
                html: reportHtml,
                width: '600px',
                confirmButtonText: '‡∏õ‡∏¥‡∏î'
            });

        } catch (error) {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' });
        }
    }

        function confirmClearData(type) {
            Swal.fire({
                title: `‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${type === 'activity' ? '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' : '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠'}?`, text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#8b5cf6', confirmButtonText: '‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (type === 'activity') {
                        activityRecords = [];
                        localStorage.removeItem('scoutActivityRecords');
                    } else {
                        attendanceRecords = [];
                        localStorage.removeItem('scoutAttendanceRecords');
                    }
                    Swal.fire({ icon: 'success', title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', confirmButtonColor: '#10b981' });
                }
            });
        }
    </script>
</body>
</html>
