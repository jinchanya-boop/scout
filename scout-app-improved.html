<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #ddd6fe 100%); }
        .card-shadow { box-shadow: 0 4px 20px rgba(139, 92, 246, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3); }
        .selected-item {
            display: inline-block;
            background-color: #e9d5ff;
            border: 1px solid #c4b5fd;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .selected-item .remove-btn {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #7c3aed;
            font-weight: bold;
        }
        .image-preview { width: 100%; height: 150px; object-fit: cover; border: 1px solid #ddd6fe; }
    </style>
</head>
<body class="gradient-bg">

<div class="sticky top-0 z-50 bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-4">
        <h1 class="text-2xl font-bold text-purple-600">üìã ‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
    </div>
</div>

<div class="max-w-7xl mx-auto p-4">
    <div class="bg-white rounded-2xl card-shadow p-8 space-y-6">

        <!-- Grade Selection -->
        <div>
            <label class="block text-lg font-semibold text-gray-700 mb-3">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
            <select id="gradeSelect" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg" onchange="onGradeChange()">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                <option value="‡∏°.1">‡∏°.1</option>
                <option value="‡∏°.2">‡∏°.2</option>
                <option value="‡∏°.3">‡∏°.3</option>
            </select>
        </div>

        <!-- Group/Troop Selection (Multiple with limit of 4) -->
        <div>
            <label class="block text-lg font-semibold text-gray-700 mb-3">üèïÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏≠‡∏á/‡∏´‡∏°‡∏π‡πà (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</label>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">‡∏Å‡∏≠‡∏á</label>
                    <select id="groupSelect" class="w-full px-3 py-2 border-2 border-purple-200 rounded-lg">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">‡∏´‡∏°‡∏π‡πà</label>
                    <select id="troopSelect" class="w-full px-3 py-2 border-2 border-purple-200 rounded-lg">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà --</option>
                    </select>
                </div>
            </div>
            <button type="button" onclick="addGroupTroopSelection()" class="w-full px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-semibold transition">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏Å‡∏≠‡∏á/‡∏´‡∏°‡∏π‡πà
            </button>
            <div id="selectedGroupsTroops" class="mt-4 flex flex-wrap gap-2"></div>
        </div>

        <!-- Activity Name -->
        <div>
            <label class="block text-lg font-semibold text-gray-700 mb-3">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
            <input type="text" id="activityName" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°">
        </div>

        <!-- Time -->
        <div>
            <label class="block text-lg font-semibold text-gray-700 mb-3">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
            <input type="time" id="activityTime" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg">
        </div>

        <!-- Attendance Summary -->
        <div class="bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4">
            <h3 class="font-semibold text-emerald-800 mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3>
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏°‡∏≤</label>
                    <input type="number" id="summaryPresent" class="w-full px-3 py-2 border border-emerald-200 rounded" min="0" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏•‡∏≤</label>
                    <input type="number" id="summaryLeave" class="w-full px-3 py-2 border border-emerald-200 rounded" min="0" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏Ç‡∏≤‡∏î</label>
                    <input type="number" id="summaryAbsent" class="w-full px-3 py-2 border border-emerald-200 rounded" min="0" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="number" id="summarySkipped" class="w-full px-3 py-2 border border-emerald-200 rounded" min="0" value="0">
                </div>
            </div>
        </div>

        <!-- Total Score & Grade Level -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (0-100)</label>
                <input type="number" id="totalScore" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg" min="0" max="100" value="0">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏•</label>
                <select id="gradeLevel" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg">
                    <option value="‡∏ú‡πà‡∏≤‡∏ô">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</option>
                    <option value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
                </select>
            </div>
        </div>

        <!-- Comments -->
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô/‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ó‡πå</label>
            <textarea id="comments" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg" rows="3" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô..."></textarea>
        </div>

        <!-- Photo Upload (4 photos) -->
        <div class="space-y-4">
            <h3 class="font-semibold text-lg text-gray-700">üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (4 ‡∏£‡∏π‡∏õ)</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="photo1" class="block p-4 rounded-lg text-center bg-purple-100 border-2 border-purple-300 cursor-pointer">üì∑ ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1</label>
                    <input type="file" id="photo1" accept="image/*" class="hidden" onchange="previewImage('photo1')">
                    <img id="preview1" class="image-preview rounded-lg mt-2 hidden">
                </div>
                <div>
                    <label for="photo2" class="block p-4 rounded-lg text-center bg-purple-100 border-2 border-purple-300 cursor-pointer">üì∑ ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2</label>
                    <input type="file" id="photo2" accept="image/*" class="hidden" onchange="previewImage('photo2')">
                    <img id="preview2" class="image-preview rounded-lg mt-2 hidden">
                </div>
                <div>
                    <label for="photo3" class="block p-4 rounded-lg text-center bg-purple-100 border-2 border-purple-300 cursor-pointer">üì∑ ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 3</label>
                    <input type="file" id="photo3" accept="image/*" class="hidden" onchange="previewImage('photo3')">
                    <img id="preview3" class="image-preview rounded-lg mt-2 hidden">
                </div>
                <div>
                    <label for="photo4" class="block p-4 rounded-lg text-center bg-purple-100 border-2 border-purple-300 cursor-pointer">üì∑ ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4</label>
                    <input type="file" id="photo4" accept="image/*" class="hidden" onchange="previewImage('photo4')">
                    <img id="preview4" class="image-preview rounded-lg mt-2 hidden">
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <button onclick="saveActivity()" class="w-full px-4 py-3 btn-primary text-white rounded-lg font-semibold transition">
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        </button>

    </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwG99XSvG0hONe5VPpUhL_N9zxdCvh6M-ZL29Bp5GvWr5A1tAHD2cQFJQNhCYH5ZsIP/exec';

let studentData = {};
let selectedGroupsTroops = [];

window.onload = async function() {
    await loadStudentData();
};

function onGradeChange() {
    const grade = document.getElementById('gradeSelect').value;
    const groupSelect = document.getElementById('groupSelect');
    groupSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á --</option>';
    document.getElementById('troopSelect').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà --</option>';
    
    if (grade && studentData[grade]) {
        Object.keys(studentData[grade]).forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
        });
    }
}

function onGroupChange() {
    const grade = document.getElementById('gradeSelect').value;
    const group = document.getElementById('groupSelect').value;
    const troopSelect = document.getElementById('troopSelect');
    troopSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà --</option>';
    
    if (grade && group && studentData[grade][group]) {
        Object.keys(studentData[grade][group]).forEach(troop => {
            const option = document.createElement('option');
            option.value = troop;
            option.textContent = troop;
            troopSelect.appendChild(option);
        });
    }
}

document.getElementById('groupSelect').addEventListener('change', onGroupChange);

function addGroupTroopSelection() {
    const group = document.getElementById('groupSelect').value;
    const troop = document.getElementById('troopSelect').value;
    
    if (!group || !troop) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏´‡∏°‡∏π‡πà');
        return;
    }
    
    if (selectedGroupsTroops.length >= 4) {
        alert('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        return;
    }
    
    const isDuplicate = selectedGroupsTroops.some(item => item.group === group && item.troop === troop);
    if (isDuplicate) {
        alert('‡∏Å‡∏≠‡∏á/‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        return;
    }
    
    selectedGroupsTroops.push({group, troop});
    updateSelectedDisplay();
}

function removeGroupTroopSelection(index) {
    selectedGroupsTroops.splice(index, 1);
    updateSelectedDisplay();
}

function updateSelectedDisplay() {
    const container = document.getElementById('selectedGroupsTroops');
    container.innerHTML = selectedGroupsTroops.map((item, index) => 
        `<div class="selected-item">${item.group} / ${item.troop} 
            <span class="remove-btn" onclick="removeGroupTroopSelection(${index})">‚úï</span>
        </div>`
    ).join('');
}

function previewImage(photoNum) {
    const fileInput = document.getElementById(photoNum);
    const preview = document.getElementById(`preview${photoNum.replace('photo', '')}`);
    
    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(fileInput.files[0]);
    }
}

async function saveActivity() {
    const grade = document.getElementById('gradeSelect').value;
    const activityName = document.getElementById('activityName').value;
    const time = document.getElementById('activityTime').value;
    const comments = document.getElementById('comments').value;
    const totalScore = document.getElementById('totalScore').value;
    const gradeLevel = document.getElementById('gradeLevel').value;
    
    if (!grade || !activityName || selectedGroupsTroops.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
    }
    
    for (let i = 0; i < selectedGroupsTroops.length; i++) {
        const {group, troop} = selectedGroupsTroops[i];
        
        const photo1Data = document.getElementById('photo1').files[0] ? await fileToBase64(document.getElementById('photo1').files[0]) : '';
        const photo2Data = document.getElementById('photo2').files[0] ? await fileToBase64(document.getElementById('photo2').files[0]) : '';
        const photo3Data = document.getElementById('photo3').files[0] ? await fileToBase64(document.getElementById('photo3').files[0]) : '';
        const photo4Data = document.getElementById('photo4').files[0] ? await fileToBase64(document.getElementById('photo4').files[0]) : '';
        
        const data = {
            type: 'activity',
            timestamp: new Date().toLocaleString('th-TH'),
            grade,
            time,
            activity: activityName,
            selectedGroup: group,
            selectedTroop: troop,
            summaryPresent: document.getElementById('summaryPresent').value,
            summaryLeave: document.getElementById('summaryLeave').value,
            summaryAbsent: document.getElementById('summaryAbsent').value,
            summarySkipped: document.getElementById('summarySkipped').value,
            totalScore,
            gradeLevel,
            comments,
            rubricScores: { criteria_0: '', criteria_1: '', criteria_2: '', criteria_3: '' },
            photo1: photo1Data,
            photo2: photo2Data,
            photo3: photo3Data,
            photo4: photo4Data,
            signature: '',
            notes: ''
        };
        
        try {
            const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            const result = await response.json();
            
            if (result.status === 'success') {
                console.log(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i+1} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
        } catch (error) {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            return;
        }
    }
    
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    clearForm();
}

function clearForm() {
    document.getElementById('gradeSelect').value = '';
    document.getElementById('activityName').value = '';
    document.getElementById('activityTime').value = '';
    document.getElementById('comments').value = '';
    document.getElementById('totalScore').value = 0;
    document.getElementById('gradeLevel').value = '‡∏ú‡πà‡∏≤‡∏ô';
    document.getElementById('summaryPresent').value = 0;
    document.getElementById('summaryLeave').value = 0;
    document.getElementById('summaryAbsent').value = 0;
    document.getElementById('summarySkipped').value = 0;
    selectedGroupsTroops = [];
    updateSelectedDisplay();
    ['photo1', 'photo2', 'photo3', 'photo4'].forEach(id => {
        document.getElementById(id).value = '';
        document.getElementById(`preview${id.replace('photo', '')}`).classList.add('hidden');
    });
}

async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
    });
}

async function loadStudentData() {
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getStudents`);
        studentData = await response.json();
        console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', studentData);
    } catch (error) {
        console.error('Error loading student data:', error);
    }
}
</script>

</body>
</html>
